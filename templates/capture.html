{% extends "layout.html" %}

{% block title %}
    Capture
{% endblock %}

{% block main %}
<video id="camera" width=320 height=240 controls autoplay>Camera stream</video>
<button type="button" id="capturebutton" class="btn btn-primary">Capture Image</button>
<canvas class="camera-image" id="canvas" width=320 height=240></canvas>
<label id="location">GPS Co-ordinates</label>
<label><a id="imageurl">Image URL</a></label>

<script>
  const camera = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const captureButton = document.getElementById('capturebutton');
  const gpsLabel = document.getElementById("location");
  const imageUrlLabel = document.getElementById("imageurl");

  context.font = "20px Arial";
  context.fillText("Please capture an image !", 45, 120)

  const constraints = {
    video : true
  };

  navigator.mediaDevices.getUserMedia(constraints)
    .then((stream) => {
    camera.srcObject = stream;
  });

  captureButton.addEventListener('click', () => {
    /* Draw Image */
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.drawImage(camera, 0, 0, canvas.width, canvas.height)

    /* Get the image in Base64 encoding and skip header part */
    var imageBase64 = canvas.toDataURL().slice(22);

    /* Upload the image to imgur */
    $.ajax({
      url: "https://api.imgur.com/3/image",
      type: "POST",
      datatype: "json",
      headers: {
        "Authorization": "Client-ID f58da3baf47229c",
        "Authorization" : "Bearer 80dc58f5739f9a81270e0c460e3801a729b78d2b"
      },
      data: {
        "image": imageBase64
      }
    }).done( response => {
      console.log("https://imgur.com/" + response.data.id + ".png");

      url = "https://imgur.com/" + response.data.id
      imageUrlLabel.innerHTML = url
      imageUrlLabel.setAttribute("href", url)
      
    }).fail( () => {
      console.log('Image upload to Imgur failed');
    });

    /* Get location */
    navigator.geolocation.getCurrentPosition( position => {


      const latitude = position.coords.latitude
      const longitude = position.coords.longitude

      gpsLabel.innerHTML = latitude + ", " + longitude;

    });


    /* Send image in base64 format to flask server */
    $.post("/",
    {
      imageBase64 : imageBase64
    }).done( () => {
      console.log('Image sent to the server');
    }).fail( () => {
      console.log('Could not send data to server');
    });

  });


</script>
{% endblock %}
